name: Beta Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.2.0)'
        required: true
        type: string
      track:
        description: 'Play Store track'
        type: choice
        options:
          - internal
          - beta
        default: beta

jobs:
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.38.2'
          cache: true

      - name: Fix git ownership (act only)
        if: ${{ env.ACT }}
        run: git config --global --add safe.directory '*'

      - name: Get dependencies
        run: flutter pub get

      - name: Cache build_runner
        id: build-runner-cache
        uses: actions/cache@v4
        with:
          path: |
            .dart_tool/build
          key: ${{ runner.os }}-build_runner-${{ hashFiles('**/*.dart') }}
          restore-keys: |
            ${{ runner.os }}-build_runner-

      - name: Generate code
        if: steps.build-runner-cache.outputs.cache-hit != 'true'
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Clean build directory
        run: flutter clean

      - name: Clean Gradle build
        working-directory: android
        run: |
          if [ -f ./gradlew ]; then
            chmod +x ./gradlew
            ./gradlew clean
          else
            echo "⚠️ gradlew not found, skipping Gradle clean"
          fi

      - name: Verify MainActivity exists
        run: |
          echo "Current directory: $(pwd)"
          echo "Checking for MainActivity.kt..."
          if [ -f android/app/src/main/kotlin/com/shenepoy/adati/MainActivity.kt ]; then
            echo "✅ MainActivity.kt found"
            ls -la android/app/src/main/kotlin/com/shenepoy/adati/MainActivity.kt
            cat android/app/src/main/kotlin/com/shenepoy/adati/MainActivity.kt
          else
            echo "❌ MainActivity.kt not found at: android/app/src/main/kotlin/com/shenepoy/adati/MainActivity.kt"
            echo "Listing android/app/src/main/kotlin:"
            find android/app/src/main/kotlin -type f 2>/dev/null || echo "kotlin directory not found"
            exit 1
          fi

      - name: Verify AndroidManifest
        run: |
          if ! grep -q 'package="com.shenepoy.adati"' android/app/src/main/AndroidManifest.xml; then
            echo "❌ Package attribute missing in AndroidManifest.xml!"
            exit 1
          fi
          if ! grep -q 'android:name="com.shenepoy.adati.MainActivity"' android/app/src/main/AndroidManifest.xml; then
            echo "❌ MainActivity name incorrect in AndroidManifest.xml!"
            exit 1
          fi
          echo "✅ AndroidManifest.xml verified"

      - name: Setup Android signing
        run: |
          if [ -n "${{ secrets.KEYSTORE_FILE }}" ]; then
            echo "Setting up release signing..."
            echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > android/app/release.keystore
            
            echo "storeFile=release.keystore" > android/key.properties
            echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
            echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
            echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
            echo "✓ Release signing configured"
          else
            echo "⚠ No signing secrets found, will use debug signing"
          fi

      - name: Build Release APK
        run: flutter build apk --release --no-tree-shake-icons
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Verify MainActivity in APK
        run: |
          if ! unzip -l build/app/outputs/flutter-apk/app-release.apk | grep -q "classes.dex"; then
            echo "❌ classes.dex not found in APK!"
            exit 1
          fi
          # Check if MainActivity class is referenced in the DEX
          if ! unzip -p build/app/outputs/flutter-apk/app-release.apk classes.dex 2>/dev/null | strings | grep -qi "MainActivity"; then
            echo "⚠️ MainActivity not found in classes.dex, but continuing..."
          else
            echo "✅ MainActivity found in APK"
          fi
          echo "APK size: $(ls -lh build/app/outputs/flutter-apk/app-release.apk | awk '{print $5}')"

      - name: Build Release App Bundle
        run: flutter build appbundle --release --no-tree-shake-icons
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: Upload Release App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-release
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.38.2'
          cache: true

      - name: Fix git ownership (act only)
        if: ${{ env.ACT }}
        run: git config --global --add safe.directory '*'

      - name: Get dependencies
        run: flutter pub get

      - name: Cache build_runner
        id: build-runner-cache
        uses: actions/cache@v4
        with:
          path: |
            .dart_tool/build
          key: ${{ runner.os }}-build_runner-${{ hashFiles('**/*.dart') }}
          restore-keys: |
            ${{ runner.os }}-build_runner-

      - name: Generate code
        if: steps.build-runner-cache.outputs.cache-hit != 'true'
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libgtk-3-dev libblkid-dev liblzma-dev

      - name: Clean build directory
        run: flutter clean

      - name: Build Linux
        run: flutter build linux --release --no-tree-shake-icons

      - name: Cache AppImageTool
        id: cache-appimagetool
        uses: actions/cache@v4
        with:
          path: /opt/appimagetool
          key: appimagetool-continuous

      - name: Install AppImageTool
        if: steps.cache-appimagetool.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage --appimage-extract
          sudo mv squashfs-root /opt/appimagetool

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

      - name: Copy Linux build to AppDir
        run: |
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          
          if [ -f assets/icon.png ]; then
            cp assets/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/adati.png
            cp assets/icon.png AppDir/adati.png
          fi
          
          cat > AppDir/usr/share/applications/adati.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=Adati
          Comment=A habit tracker app
          Exec=usr/bin/adati
          Icon=adati
          Categories=Utility;
          EOF
          
          cp AppDir/usr/share/applications/adati.desktop AppDir/adati.desktop

      - name: Create AppImage
        run: |
          ARCH=x86_64 /opt/appimagetool/AppRun AppDir adati-x86_64.AppImage

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: adati-x86_64.AppImage
          retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.38.2'
          cache: true

      - name: Fix git ownership (act only)
        if: ${{ env.ACT }}
        run: git config --global --add safe.directory '*'

      - name: Get dependencies
        run: flutter pub get

      - name: Cache build_runner
        id: build-runner-cache
        uses: actions/cache@v4
        with:
          path: |
            .dart_tool/build
          key: ${{ runner.os }}-build_runner-${{ hashFiles('**/*.dart') }}
          restore-keys: |
            ${{ runner.os }}-build_runner-

      - name: Generate code
        if: steps.build-runner-cache.outputs.cache-hit != 'true'
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Clean build directory
        run: flutter clean

      - name: Build Windows
        run: flutter build windows --release --no-tree-shake-icons

      - name: Get version from tag or input
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.version }}") {
            $version = "${{ github.event.inputs.version }}"
          } else {
            $ref = "${{ github.ref }}"
            if ($ref -match "refs/tags/v(.+)") {
              $version = $matches[1]
            } else {
              $version = (Get-Content pubspec.yaml | Select-String "^version:" | ForEach-Object { $_.Line.Split()[1].Split('+')[0] })
            }
          }
          Write-Host "Version: $version"
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Package Windows release
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $releaseDir = "build\windows\x64\runner\Release"
          $zipName = "adati-$version-windows-x64.zip"
          $exeName = "adati-$version-windows-x64.exe"
          
          # Create ZIP with all dependencies
          Compress-Archive -Path "$releaseDir\*" -DestinationPath $zipName -Force
          Write-Host "Created: $zipName"
          
          # Copy standalone exe (note: requires DLLs and data folder to run)
          Copy-Item "$releaseDir\adati.exe" -Destination $exeName
          Write-Host "Created: $exeName"

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: adati-*-windows-x64.zip
          retention-days: 30

      - name: Upload Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: adati-*-windows-x64.exe
          retention-days: 30

  deploy-play-store:
    name: Deploy to Play Store
    needs: build-android
    runs-on: ubuntu-latest
    if: github.event.inputs.track != '' || startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: android

      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: android-aab-release
          path: build/app/outputs/bundle/release/

      - name: Deploy to Play Store
        env:
          PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}
        run: |
          cd android
          bundle exec fastlane deploy_${{ github.event.inputs.track || 'beta' }}

  create-github-prerelease:
    name: Create GitHub Prerelease
    needs: [build-android, build-linux, build-windows]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="v$VERSION"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            TAG=${GITHUB_REF#refs/tags/}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          find . -type f -name "*.apk" -o -name "*.aab" -o -name "*.AppImage" -o -name "*.zip" -o -name "*.exe" | head -20
          echo ""
          echo "=== Artifact Directories ==="
          ls -la
          echo ""
          echo "=== Android Artifacts ==="
          ls -la android-* 2>/dev/null || echo "No android artifacts found"
          echo ""
          echo "=== Linux Artifacts ==="
          ls -la linux-* 2>/dev/null || echo "No linux artifacts found"
          echo ""
          echo "=== Windows Artifacts ==="
          ls -la windows-* 2>/dev/null || echo "No windows artifacts found"

      - name: Prepare release artifacts
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          MISSING_ARTIFACTS=()
          
          # Android APK and AAB
          if [ -f android-apk-release/app-release.apk ]; then
            cp android-apk-release/app-release.apk adati-${VERSION}-android.apk
            echo "✅ Android APK prepared"
          else
            MISSING_ARTIFACTS+=("Android APK")
            echo "⚠️ Android APK not found"
          fi
          
          if [ -f android-aab-release/app-release.aab ]; then
            cp android-aab-release/app-release.aab adati-${VERSION}-android.aab
            echo "✅ Android AAB prepared"
          else
            MISSING_ARTIFACTS+=("Android AAB")
            echo "⚠️ Android AAB not found"
          fi
          
          # Linux AppImage
          if [ -f linux-appimage/adati-x86_64.AppImage ]; then
            cp linux-appimage/adati-x86_64.AppImage adati-${VERSION}-linux-x86_64.AppImage
            chmod +x adati-${VERSION}-linux-x86_64.AppImage
            echo "✅ Linux AppImage prepared"
          else
            MISSING_ARTIFACTS+=("Linux AppImage")
            echo "⚠️ Linux AppImage not found"
          fi
          
          # Windows ZIP (full package with DLLs)
          if ls windows-zip/adati-*-windows-x64.zip 1> /dev/null 2>&1; then
            cp windows-zip/adati-*-windows-x64.zip adati-${VERSION}-windows-x64.zip
            echo "✅ Windows ZIP prepared"
          else
            MISSING_ARTIFACTS+=("Windows ZIP")
            echo "⚠️ Windows ZIP not found"
          fi
          
          # Windows EXE (standalone, for reference)
          if ls windows-exe/adati-*-windows-x64.exe 1> /dev/null 2>&1; then
            cp windows-exe/adati-*-windows-x64.exe adati-${VERSION}-windows-x64.exe
            echo "✅ Windows EXE prepared"
          else
            MISSING_ARTIFACTS+=("Windows EXE")
            echo "⚠️ Windows EXE not found"
          fi
          
          echo ""
          echo "=== Prepared Artifacts ==="
          ls -lh adati-* 2>/dev/null || echo "No artifacts prepared"
          
          if [ ${#MISSING_ARTIFACTS[@]} -gt 0 ]; then
            echo ""
            echo "⚠️ Missing artifacts: ${MISSING_ARTIFACTS[*]}"
            echo "This may indicate build job failures. Check the workflow logs."
          fi

      - name: Create Prerelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: Beta ${{ steps.version.outputs.VERSION }}
          body: |
            ## Beta Release ${{ steps.version.outputs.VERSION }}
            
            This is a beta release for testing. Includes:
            - **Android APK**: Direct install (`adati-${{ steps.version.outputs.VERSION }}-android.apk`)
            - **Android AAB**: For Google Play Store (`adati-${{ steps.version.outputs.VERSION }}-android.aab`)
            - **Linux AppImage**: Make executable and run (`adati-${{ steps.version.outputs.VERSION }}-linux-x86_64.AppImage`)
            - **Windows ZIP**: Extract and run adati.exe (`adati-${{ steps.version.outputs.VERSION }}-windows-x64.zip`)
            - **Windows EXE**: Standalone executable, requires DLLs from ZIP (`adati-${{ steps.version.outputs.VERSION }}-windows-x64.exe`)
            
            ### Installation
            - **Android**: Install the APK directly or get it from Play Store beta track
            - **Linux**: `chmod +x adati-*.AppImage && ./adati-*.AppImage`
            - **Windows**: Extract the ZIP and run `adati.exe` (recommended) or use standalone EXE with DLLs
            
            **Testing**: Please test and report issues before promotion to production.
          files: adati-*
          draft: false
          prerelease: true

